rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // A user can only read and write their own profile document.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for the 'places' collection and its nested subcollections.
    match /places/{placeId} {
      // Any authenticated user can read a place document.
      allow read: if request.auth != null;

      // An authenticated user can create a place document ONLY if they set themselves as the creator.
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;

      // --- Documents Subcollection ---
      match /documents/{docId} {
        // Any authenticated user can read the document metadata and analysis results.
        allow read: if request.auth != null;

        // CRITICAL: No client-side writes are allowed.
        // All analysis data MUST be written by the backend Admin SDK.
        allow write: if false;
      }

      // --- Feedback Subcollection ---
      match /feedback/{feedbackId} {
        // Any authenticated user can read feedback comments.
        allow read: if request.auth != null;

        // An authenticated user can create feedback only if they are the author.
        allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      }
    }
  }
}
